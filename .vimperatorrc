" Load plugins
loadplugins

" Load userstyles
source ~/.vimperator/styles/styles.js

" {{{ Configuration

" Unfocus textfields
set focuscontent

" Incremental search
set incsearch

" Smartcase
set smartcase

" Default search
set ds=k

" Default GUI options
set go=

" Hide tabline
set showtabline=0

" Use gvim as editor
set editor="gvim -c 'set filetype=php' -f"

" Vim editing in textareas
set noinsertmode

" Leader
let mapleader=","

set vb
" }}}

" {{{ Mappings
" Show/hide toolbars
noremap <silent> <C-+> :set go+=Bm<CR>
noremap <silent> <C-=> :set go-=Bm<CR>

" Passthrough mode shortcut
noremap c <C-z>

" Next/Prev Tab
noremap w <C-Tab>
noremap v <C-S-Tab>

noremap <silent> V :tabmove -1<CR>
noremap <silent> W :tabmove +1<CR>


" Toggle userstyles/userscripts
noremap <silent> <Leader>s :styletoggle<CR>
noremap <silent> <Leader>S :loaduserstyles<CR>
noremap <silent> <Leader>g :gmset!<CR>

" Show/hide the buftabbar
noremap <silent> <A-u> :set invbuftabs<CR>

" Quick buffer switch with the same mapping as in vim
noremap <A-g> :buffer!<Space>
noremap <Leader>t :buffer!<Space>

" Detach tab
noremap <Leader>w :tabdetach<CR>

" Faster scrolling
noremap <C-e> 3<C-e>
noremap <C-y> 3<C-y>

noremap h 2h
noremap j 2j
noremap k 2k
noremap l 2l

noremap J 6j
noremap K 6k

" Remove tabs
noremap <silent> <leader>D :removetabsright<CR>
noremap <silent> <leader>d :removetabsleft<CR>

" Background tab
noremap <A-t> :tabopen!<Space>
noremap <A-w> :winopen<Space>

" Video control keys
noremap <silent> <leader>p :stplay<CR>
noremap <silent> <leader>P :stpause<CR>
noremap <silent> <leader>l :stlarge<CR>
noremap <silent> <leader>m :stmute<CR>

" Hide CmdLine right after a command
cnoremap <S-CR> <CR>
cnoremap <CR> <CR>:<Esc>

" C-l/F7: Search highlight toggle
map <silent> <F7> :noh<CR>
map <silent> <C-l> :noh<CR>

" Go to numbered page
js <<EOF
mappings.add(config.browserModes, ["gr"],
    "Go to numbered link",
    function (count) { if (count) events.feedkeys(
        "f,"+String(count)+","
    ); },
    { count: true });

mappings.add(config.browserModes, ["gR"],
    "Go to numbered link",
    function (count) { if (count) events.feedkeys(
        "F,"+String(count)+","
    ); },
    { count: true });
EOF

" Quickmark in background tab
js <<EOF
mappings.add(config.browserModes,
    ["gN"], "Jump to a QuickMark in a new tab, inverting the 'activate' option",
    function (arg) {
        quickmarks.jumpTo(arg,
            /\bquickmark\b/.test(options["activate"]) ?
            liberator.NEW_BACKGROUND_TAB : liberator.NEW_TAB);
    },
    { arg: true });
EOF

" }}}

" {{{ Styling

" Buftab styling
hi BufTab padding-left: 5px; padding-right: 5px;
hi BufTabSelected background: #343434; padding-left: 5px; padding-right: 5px;

" Hint font size
hi Hint font-family: monospace; font-size: 13px; font-weight: bold; color: white; padding: 1px 3px; background: #744E7A;
hi HintElem none: none;
hi HintActive none: none;

" Statusbar and commandline styling
hi StatusLine background: #141414; color: #9FBC00; font-family: terminus; font-size: 10pt; font-weight: normal;
hi StatusLineBroken background: #1a1414; color: #9FBC00; font-family: terminus; font-size: 10pt; font-weight: normal;
hi StatusLineExtended background: #141a14; color: #9FBC00; font-family: terminus; font-size: 10pt; font-weight: normal;
hi StatusLineSecure background: #14141a; color: #9FBC00; font-family: terminus; font-size: 10pt; font-weight: normal;

hi CmdLine height: 0px; padding: 0px; font-family: terminus; font-size: 10pt; font-weight: normal; color: white; background: #141414;
hi Normal background: #141414; color: white;
hi Question background: #141414; color: white;

" Completion colors from zenburn
hi CompDesc             color: #d0d0d0; width: 50%;font-size: 10pt;
hi CompGroup:not(:first-of-type)    margin-top: .5em;
hi CompIcon             width: 16px; min-width: 16px; display: inline-block; margin-right: .5ex;
hi CompIcon>img         max-width: 16px; max-height: 16px; vertical-align: middle;
hi CompItem             font-size: 11px;
hi CompItem>*           padding: 0 .5ex;
hi CompItem[selected]   color: #ffffd7; background: #444444;
hi CompLess             text-align: center; height: 0; line-height: .5ex; padding-top: 1ex;
hi CompLess::after      content: "\2303" /* Unicode up arrowhead */
hi CompMore             text-align: center; height: .5ex; line-height: .5ex; margin-bottom: -.5ex;
hi CompMore::after      content: "\2304" /* Unicode down arrowhead */
hi CompMsg              font-style: italic; margin-left: 16px;
hi CompResult           width: 45%; overflow: hidden;font-size: 10pt; font-family: monospace; font-weight: normal;
hi CompTitle            color: #87af87; background: #242421; font-weight: bold;
hi CompTitle>*          padding: 0 .5ex;

" }}}

" {{{ Youtube settings on load
au -js PageLoad http://(www\.)?youtube\.com/watch.* loadYoutube(args.tab)
js <<EOF
loadYoutube = function (tab)
{
    let doc = tabs.getTab(tab-1).linkedBrowser.contentDocument;
    let player = doc.getElementById("movie_player");
    let base = doc.getElementById("baseDiv");

    if (base)
    {
        // Wide mode by default
        base.className = (base.className || "")+" watch-wide-mode"
    }

    if (player)
    {
        player = player.wrappedJSObject;

        // Try the highest quality
        player.setPlaybackQuality("hd720");

        // Don't start playing
        player.pauseVideo();
    }
}
EOF
" }}}

" {{{ Quickmarks / Bookmarks
" Quickmarks
delqm!
source ~/.vimperator/qmarks

" Bookmarks
source ~/.vimperator/bookmarks
" }}}

" {{{ Readability
noremap <silent> <leader>r :js readability()<CR>
js <<EOF
readability = function()
{
    let doc = content.document;
    _readability_vars=doc.createElement('SCRIPT')
    _readability_vars.type='text/javascript'
    _readability_vars.innerHTML = "readStyle='style-apertura'; readSize='size-medium'; readMargin='margin-narrow'"
    doc.getElementsByTagName('head')[0].appendChild(_readability_vars)
    _readability_script=doc.createElement('SCRIPT')
    _readability_script.type='text/javascript'
    _readability_script.src='http://lab.arc90.com/experiments/readability/js/readability.js?x='+(Math.random())
    doc.getElementsByTagName('head')[0].appendChild(_readability_script)
    _readability_css=doc.createElement('LINK')
    _readability_css.rel='stylesheet'
    _readability_css.href='http://lab.arc90.com/experiments/readability/css/readability.css'
    _readability_css.type='text/css'
    doc.getElementsByTagName('head')[0].appendChild(_readability_css)
    _readability_print_css=doc.createElement('LINK')
    _readability_print_css.rel='stylesheet'
    _readability_print_css.href='http://lab.arc90.com/experiments/readability/css/readability-print.css'
    _readability_print_css.media='print'
    _readability_print_css.type='text/css'
    doc.getElementsByTagName('head')[0].appendChild(_readability_print_css)
}
EOF

" }}}

" auto match page nav-links
set nextpattern=\s*下一页|下一张|下一节|下一章|下一篇|下一頁|下页|后页\s*,^\bnext\b,\bnext\b,\bsuivant\b,^>$,^(>>|››|»)$,^(>|»),(>|»)$,\bmore\b
set previouspattern=\s*上一页|上一张|上一节|上一章|上一篇|上一頁|上页|前页\s*,^\bprev|previous\b,\bprev|previous\b,\bprécédent\b,^<$,^(<<|‹‹|«)$,^(<|«),(<|«)$

" pass All key map for google reader and mail
autocmd LocationChange .* :js modes.passAllKeys = /web\.qq\.com|webqq\.qq\.com|wave\.google\.com|mail\.google\.com|www\.google\.com\/reader\/view/.test(buffer.URL)

javascript <<EOF
(function(){
    var feedPanel = document.createElement("statusbarpanel");
    feedPanel.setAttribute("id", "feed-panel-clone");
    feedPanel.appendChild(document.getElementById("feed-button"));
    feedPanel.firstChild.setAttribute("style", "padding: 0; max-height: 16px;");
    document.getElementById("status-bar")
            .insertBefore(feedPanel, document.getElementById("security-button"));
})();
EOF

js<<EOF
// Toggle Tool bar
liberator.globalVariables['sx_gopt'] = 'm'
toggle_bar = function () {
    toggle_status = liberator.globalVariables['sx_gopt'];
    liberator.globalVariables['sx_gopt'] = (toggle_status == ''? 'm': '');
    liberator.execute('set guioptions=' + toggle_status);
}
EOF

js<<EOF
// Toggle Tool bar
liberator.globalVariables['sx_gopt'] = 'B'
toggle_bar_B = function () {
    toggle_status = liberator.globalVariables['sx_gopt'];
    liberator.globalVariables['sx_gopt'] = (toggle_status == ''? 'B': '');
    liberator.execute('set guioptions=' + toggle_status);
}
EOF

" map to js functions 
map <silent> <F2> :js toggle_bar() <CR>
map <silent> <F3> :js toggle_bar_B() <CR>

" autocmd VimperatorEnter .* :js toggle_bar_B()

" colorscheme sweets
" colorscheme evening
